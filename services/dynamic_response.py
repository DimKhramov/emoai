#!/usr/bin/env python3
"""
–ú–æ–¥—É–ª—å –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —ç–º–æ—Ü–∏–π
"""

from typing import Dict, Tuple

class DynamicResponseConfig:
    """
    –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    """
    
    # –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —ç–º–æ—Ü–∏–π
    EMOTION_RESPONSE_CONFIG = {
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ - —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
        "sos": {
            "max_tokens": 2000,
            "min_sentences": 6,
            "max_sentences": 12,
            "style": "supportive_detailed",
            "description": "–°—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏, —É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞"
        },
        
        # –°–∏–ª—å–Ω—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏ - –Ω—É–∂–Ω—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã —Å —ç–º–ø–∞—Ç–∏–µ–π
        "anger": {
            "max_tokens": 1500,
            "min_sentences": 4,
            "max_sentences": 8,
            "style": "empathetic_detailed",
            "description": "–ó–ª–æ—Å—Ç—å, —è—Ä–æ—Å—Ç—å - —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞—è —ç–º–ø–∞—Ç–∏—è –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ"
        },
        
        "sadness": {
            "max_tokens": 1500,
            "min_sentences": 4,
            "max_sentences": 8,
            "style": "comforting_detailed",
            "description": "–ì—Ä—É—Å—Ç—å, –ø–µ—á–∞–ª—å - —É—Ç–µ—à–µ–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞"
        },
        
        "tired": {
            "max_tokens": 1200,
            "min_sentences": 3,
            "max_sentences": 6,
            "style": "gentle_understanding",
            "description": "–£—Å—Ç–∞–ª–æ—Å—Ç—å, –≤—ã–≥–æ—Ä–∞–Ω–∏–µ - –º—è–≥–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ"
        },
        
        # –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–∏ - –∫—Ä–∞—Ç–∫–∏–µ, –Ω–æ —á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã
        "provocation": {
            "max_tokens": 800,
            "min_sentences": 2,
            "max_sentences": 4,
            "style": "firm_boundaries",
            "description": "–ü—Ä–æ–≤–æ–∫–∞—Ü–∏–∏ - —á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–∏"
        },
        
        # –û–±—ã—á–Ω—ã–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã - —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞
        "generic": {
            "max_tokens": 1000,
            "min_sentences": 3,
            "max_sentences": 5,
            "style": "warm_engaging",
            "description": "–û–±—â–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã - —Ç–µ–ø–ª–æ–µ –æ–±—â–µ–Ω–∏–µ"
        },
        
        # –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã - –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
        "neutral": {
            "max_tokens": 600,
            "min_sentences": 1,
            "max_sentences": 3,
            "style": "friendly_concise",
            "description": "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ"
        }
    }
    
    # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥–ª–∏–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    CONTEXT_MODIFIERS = {
        "first_message": 1.3,      # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —á—É—Ç—å –¥–ª–∏–Ω–Ω–µ–µ –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞
        "follow_up": 1.0,          # –û–±—ã—á–Ω–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
        "deep_conversation": 1.4,   # –ì–ª—É–±–æ–∫–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä - –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ
        "quick_exchange": 0.8,     # –ë—ã—Å—Ç—Ä—ã–π –æ–±–º–µ–Ω - –∫–æ—Ä–æ—á–µ
        "complex_topic": 1.5,      # –°–ª–æ–∂–Ω–∞—è —Ç–µ–º–∞ - –ø–æ–¥—Ä–æ–±–Ω–µ–µ
        "simple_question": 0.7     # –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å - –∫—Ä–∞—Ç–∫–æ
    }

def get_response_config(emotion_type: str, context_type: str = "follow_up") -> Dict:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç–º–æ—Ü–∏–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    
    Args:
        emotion_type: –¢–∏–ø —ç–º–æ—Ü–∏–∏ (sos, anger, sadness, etc.)
        context_type: –¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    
    Returns:
        Dict —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
    """
    # –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —ç–º–æ—Ü–∏–∏
    base_config = DynamicResponseConfig.EMOTION_RESPONSE_CONFIG.get(
        emotion_type, 
        DynamicResponseConfig.EMOTION_RESPONSE_CONFIG["neutral"]
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context_modifier = DynamicResponseConfig.CONTEXT_MODIFIERS.get(context_type, 1.0)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫ max_tokens
    adjusted_max_tokens = int(base_config["max_tokens"] * context_modifier)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º—É–º –∏ –º–∞–∫—Å–∏–º—É–º
    adjusted_max_tokens = max(300, min(2500, adjusted_max_tokens))
    
    return {
        "max_tokens": adjusted_max_tokens,
        "min_sentences": base_config["min_sentences"],
        "max_sentences": base_config["max_sentences"],
        "style": base_config["style"],
        "description": base_config["description"],
        "emotion_type": emotion_type,
        "context_type": context_type,
        "context_modifier": context_modifier
    }

def analyze_conversation_context(conversation_history: list, current_message: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    
    Args:
        conversation_history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        current_message: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    
    Returns:
        –¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    """
    if not conversation_history:
        return "first_message"
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–ª–∏–Ω—É –∏—Å—Ç–æ—Ä–∏–∏
    history_length = len(conversation_history)
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    message_length = len(current_message.split())
    current_lower = current_message.lower()
    
    # –ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    simple_questions = ["–∫–∞–∫ –¥–µ–ª–∞", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "–∫–∞–∫ —Ç—ã", "–ø—Ä–∏–≤–µ—Ç", "–ø–æ–∫–∞", "—Å–ø–∞—Å–∏–±–æ"]
    if any(q in current_lower for q in simple_questions) and message_length <= 5:
        return "simple_question"
    
    # –°–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã (–¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏)
    if message_length > 20 or "?" in current_message:
        return "complex_topic"
    
    # –ì–ª—É–±–æ–∫–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä (–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏)
    if history_length > 10:
        return "deep_conversation"
    
    # –ë—ã—Å—Ç—Ä—ã–π –æ–±–º–µ–Ω (–∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
    if message_length <= 3:
        return "quick_exchange"
    
    return "follow_up"

def get_style_instructions(style: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å—Ç–∏–ª—é –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
    
    Args:
        style: –°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞
    
    Returns:
        –¢–µ–∫—Å—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    """
    style_instructions = {
        "supportive_detailed": """
        –û—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ. –ü–æ–∫–∞–∂–∏ –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –∑–∞–±–æ—Ç—É.
        –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–º–æ—â—å. –ò—Å–ø–æ–ª—å–∑—É–π 6-12 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
        –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –∫ –¥–µ—Ç–∞–ª—è–º.
        """,
        
        "empathetic_detailed": """
        –û—Ç–≤–µ—á–∞–π —Å –≥–ª—É–±–æ–∫–æ–π —ç–º–ø–∞—Ç–∏–µ–π –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º. –ü—Ä–∏–∑–Ω–∞–π —á—É–≤—Å—Ç–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞.
        –ü—Ä–µ–¥–ª–æ–∂–∏ —Å–ø–æ—Å–æ–±—ã —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π 4-8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
        –ü–æ–∫–∞–∂–∏, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å –ø—Ä–∏—á–∏–Ω—ã –∑–ª–æ—Å—Ç–∏ –∏ –≥–æ—Ç–æ–≤ –≤—ã—Å–ª—É—à–∞—Ç—å.
        """,
        
        "comforting_detailed": """
        –û—Ç–≤–µ—á–∞–π —Ç–µ–ø–ª–æ –∏ —É—Ç–µ—à–∞—é—â–µ. –û–∫–∞–∂–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É.
        –ü–æ–º–æ–≥–∏ —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É. –ò—Å–ø–æ–ª—å–∑—É–π 4-8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
        –ë—É–¥—å –º—è–≥–∫–∏–º, –Ω–æ –Ω–µ –±–∞–Ω–∞–ª—å–Ω—ã–º –≤ —É—Ç–µ—à–µ–Ω–∏–∏.
        """,
        
        "gentle_understanding": """
        –û—Ç–≤–µ—á–∞–π –º—è–≥–∫–æ –∏ —Å –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º —É—Å—Ç–∞–ª–æ—Å—Ç–∏. –ù–µ —Ç—Ä–µ–±—É–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
        –ü—Ä–µ–¥–ª–æ–∂–∏ –æ—Ç–¥—ã—Ö –∏–ª–∏ –ø—Ä–æ—Å—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π 3-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
        –ü–æ–∫–∞–∂–∏, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏—Å—Ç–æ—â–µ–Ω–∏—è.
        """,
        
        "firm_boundaries": """
        –û—Ç–≤–µ—á–∞–π —Å–ø–æ–∫–æ–π–Ω–æ, –Ω–æ —á–µ—Ç–∫–æ –æ–±–æ–∑–Ω–∞—á—å –≥—Ä–∞–Ω–∏—Ü—ã. –ù–µ –ø–æ–¥–¥–∞–≤–∞–π—Å—è –Ω–∞ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–∏.
        –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å –Ω–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
        –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º, –Ω–æ —Ç–≤–µ—Ä–¥—ã–º.
        """,
        
        "warm_engaging": """
        –û—Ç–≤–µ—á–∞–π —Ç–µ–ø–ª–æ –∏ –≤–æ–≤–ª–µ–∫–∞—é—â–µ. –ü–æ–¥–¥–µ—Ä–∂–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä.
        –ó–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –ò—Å–ø–æ–ª—å–∑—É–π 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
        –ü–æ–∫–∞–∂–∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Ç–µ–º–µ.
        """,
        
        "friendly_concise": """
        –û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º, –Ω–æ –Ω–µ –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–º.
        –ò—Å–ø–æ–ª—å–∑—É–π 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –û—Ç–≤–µ—á–∞–π –ø–æ —Å—É—â–µ—Å—Ç–≤—É —Å —Ç–µ–ø–ª–æ—Ç–æ–π.
        """
    }
    
    return style_instructions.get(style, style_instructions["friendly_concise"]).strip()

def format_response_config_info(config: Dict) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    
    Args:
        config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    """
    return f"""
üéØ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞:
   –≠–º–æ—Ü–∏—è: {config['emotion_type']} 
   –ö–æ–Ω—Ç–µ–∫—Å—Ç: {config['context_type']}
   Max tokens: {config['max_tokens']}
   –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: {config['min_sentences']}-{config['max_sentences']}
   –°—Ç–∏–ª—å: {config['style']}
   –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä: {config['context_modifier']}
   –û–ø–∏—Å–∞–Ω–∏–µ: {config['description']}
    """.strip()